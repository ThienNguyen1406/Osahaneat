<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="OSAHANEAT - Qu·∫£n l√Ω menu" />
    <meta name="author" content="OSAHANEAT" />
    <title>OSAHANEAT - Qu·∫£n l√Ω menu</title>
    <link rel="icon" type="image/png" href="../admin/img/favicon.png">
    <link href="../admin/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fontawesome Icon - CDN for better compatibility -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Fallback to local -->
    <link href="../admin/vendor/fontawesome/css/fontawesome.min.css" rel="stylesheet" type="text/css">
    <link href="css/owner.css" rel="stylesheet" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark owner-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-store mr-2"></i>
                <strong>OSAHANEAT</strong> <span class="badge badge-light ml-2">OWNER</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="restaurants.html">
                            <i class="fas fa-store"></i> C·ª≠a h√†ng
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="menu.html">
                            <i class="fas fa-utensils"></i> Menu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">
                            <i class="fas fa-shopping-bag"></i> ƒê∆°n h√†ng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="staff.html">
                            <i class="fas fa-users"></i> Nh√¢n vi√™n
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../admin/login.html" onclick="ownerLogout(); return false;">
                            <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12 d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="owner-page-title">
                        <i class="fas fa-utensils mr-2"></i>Qu·∫£n l√Ω menu
                    </h2>
                    <p class="text-muted">
                        <i class="fas fa-info-circle mr-1"></i>Qu·∫£n l√Ω m√≥n ƒÉn c·ªßa c·ª≠a h√†ng
                    </p>
                </div>
                <div>
                    <select class="form-control d-inline-block" id="restaurant-select" style="width: auto;">
                        <option value="">Ch·ªçn c·ª≠a h√†ng...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Menu Tabs -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-tabs" id="menu-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="active-menu-tab" data-toggle="tab" href="#active-menu" role="tab" aria-controls="active-menu" aria-selected="true">
                            <i class="fas fa-check-circle mr-1"></i>M√≥n ƒëang hi·ªÉn th·ªã
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="hidden-menu-tab" data-toggle="tab" href="#hidden-menu" role="tab" aria-controls="hidden-menu" aria-selected="false">
                            <i class="fas fa-eye-slash mr-1"></i>M√≥n ƒë√£ ·∫©n
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="menu-tab-content">
            <!-- Active Menu Tab -->
            <div class="tab-pane fade show active" id="active-menu" role="tabpanel" aria-labelledby="active-menu-tab">
                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" class="form-control" id="search-menu" placeholder="T√¨m ki·∫øm m√≥n ƒÉn..." />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                            </div>
                            <select class="form-control" id="filter-category">
                                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Menu Grid -->
                <div class="row" id="menu-grid">
            <div class="col-12 text-center py-5">
                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                <p class="text-muted">Ch·ªçn c·ª≠a h√†ng ƒë·ªÉ xem menu</p>
            </div>
        </div>
            </div>
            
            <!-- Hidden Menu Tab -->
            <div class="tab-pane fade" id="hidden-menu" role="tabpanel" aria-labelledby="hidden-menu-tab">
                <!-- Search and Filter for Hidden Menu -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" class="form-control" id="search-hidden-menu" placeholder="T√¨m ki·∫øm m√≥n ƒë√£ ·∫©n..." />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-tags"></i></span>
                            </div>
                            <select class="form-control" id="filter-hidden-category">
                                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hidden Menu Grid -->
                <div class="row" id="hidden-menu-grid">
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-eye-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ch·ªçn c·ª≠a h√†ng ƒë·ªÉ xem m√≥n ƒë√£ ·∫©n</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Menu Button (Fixed) -->
        <div class="fixed-action-btn" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
            <button class="btn btn-owner btn-owner-primary btn-lg rounded-circle shadow-lg" 
                    id="add-menu-btn"
                    title="Th√™m m√≥n ƒÉn m·ªõi"
                    style="width: 60px; height: 60px; padding: 0; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-plus fa-lg"></i>
            </button>
        </div>
    </div>

    <!-- Add/Edit Menu Modal -->
    <div class="modal fade" id="menuModal" tabindex="-1" role="dialog" aria-labelledby="menuModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuModalLabel">Th√™m m√≥n ƒÉn m·ªõi</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="menu-form">
                        <input type="hidden" id="menu-id" value="">
                        <div class="form-group">
                            <label for="menu-title">T√™n m√≥n ƒÉn <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="menu-title" required>
                        </div>
                        <div class="form-group">
                            <label for="menu-description">M√¥ t·∫£</label>
                            <textarea class="form-control" id="menu-description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="menu-category">Danh m·ª•c <span class="text-danger">*</span></label>
                            <select class="form-control" id="menu-category" required>
                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="menu-price">Gi√° (‚Ç´) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="menu-price" min="0" step="1000" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="menu-shipping-fee">Ph√≠ ship (‚Ç´) <span class="text-muted small">(Doanh thu shipper)</span></label>
                                    <input type="number" class="form-control" id="menu-shipping-fee" min="0" step="1000" value="15000" placeholder="15000">
                                    <small class="form-text text-muted">Ph√≠ ship m√† shipper s·∫Ω nh·∫≠n ƒë∆∞·ª£c</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="menu-time-ship">Th·ªùi gian ship</label>
                                    <input type="text" class="form-control" id="menu-time-ship" placeholder="VD: 30 ph√∫t">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="menu-is-freeship">
                                <label class="form-check-label" for="menu-is-freeship">
                                    Mi·ªÖn ph√≠ ship
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="menu-image">·∫¢nh m√≥n ƒÉn <span class="text-danger" id="image-required">*</span></label>
                            <input type="file" class="form-control-file" id="menu-image" accept="image/*">
                            <small class="form-text text-muted">Ch·ªçn ·∫£nh cho m√≥n ƒÉn (JPG, PNG)</small>
                            <div id="menu-image-preview" class="mt-2" style="display: none;">
                                <small class="text-muted">·∫¢nh hi·ªán t·∫°i:</small><br>
                                <img id="menu-current-image" src="" alt="Current image" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 8px;">
                            </div>
                            <div id="menu-new-image-preview" class="mt-2" style="display: none;">
                                <small class="text-muted">·∫¢nh m·ªõi:</small><br>
                                <img id="menu-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 4px; margin-top: 8px;">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-owner btn-owner-primary" id="save-menu-btn">
                        <i class="fas fa-save mr-1"></i>L∆∞u
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../admin/vendor/jquery/jquery.min.js"></script>
    <script src="../admin/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../admin/js/api.js"></script>
    <script src="js/owner.js"></script>
    <script>
        let allMenus = [];
        let categories = [];

        $(document).ready(function() {
            if (!isAuthenticated()) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                window.location.href = '../admin/login.html';
                return;
            }
            
            loadRestaurants();
            loadCategories();
            
            $('#restaurant-select').on('change', function() {
                const restaurantId = $(this).val();
                if (restaurantId) {
                    loadMenu(restaurantId);
                } else {
                    $('#menu-grid').html('<div class="col-12 text-center py-5"><i class="fas fa-utensils fa-3x text-muted mb-3"></i><p class="text-muted">Ch·ªçn c·ª≠a h√†ng ƒë·ªÉ xem menu</p></div>');
                }
            });
            
            $('#search-menu').on('input', filterMenu);
            $('#filter-category').on('change', filterMenu);
            $('#search-hidden-menu').on('input', filterHiddenMenu);
            $('#filter-hidden-category').on('change', filterHiddenMenu);
            
            // When tab changes, reload menu to ensure correct display
            $('#menu-tabs a').on('shown.bs.tab', function(e) {
                const restaurantId = $('#restaurant-select').val();
                if (restaurantId) {
                    // Re-filter menus when switching tabs
                    renderMenuByStatus();
                }
            });
        });

        function loadRestaurants() {
            OwnerApiService.getMyRestaurants()
                .done(function(response) {
                    if (response && (response.success || response.isSuccess) && response.data) {
                        const restaurants = Array.isArray(response.data) ? response.data : [];
                        const $select = $('#restaurant-select');
                        restaurants.forEach(function(restaurant) {
                            $select.append(`<option value="${restaurant.id}">${restaurant.title || 'N/A'}</option>`);
                        });
                    }
                })
                .fail(function(xhr) {
                    console.error('Error loading restaurants:', xhr);
                });
        }

        function loadCategories() {
            // Try AdminApiService first (if available)
            if (typeof AdminApiService !== 'undefined' && AdminApiService.getCategories) {
                AdminApiService.getCategories()
                    .done(function(response) {
                        if (response && (response.success || response.isSuccess) && response.data) {
                            categories = Array.isArray(response.data) ? response.data : [];
                            populateCategorySelects();
                        }
                    })
                    .fail(function(xhr) {
                        console.error('Error loading categories:', xhr);
                        // Try alternative API
                        loadCategoriesAlternative();
                    });
            } else {
                loadCategoriesAlternative();
            }
        }
        
        function loadCategoriesAlternative() {
            // Alternative: Use public API endpoint
            $.ajax({
                method: 'GET',
                url: 'http://localhost:82/category',
                dataType: 'json'
            })
                .done(function(response) {
                    if (response && response.data && Array.isArray(response.data)) {
                        categories = response.data;
                        populateCategorySelects();
                    }
                })
                .fail(function(xhr) {
                    console.error('Error loading categories from alternative API:', xhr);
                });
        }
        
        function populateCategorySelects() {
            const $filterSelect = $('#filter-category');
            const $menuSelect = $('#menu-category');
            
            // Clear existing options (except first option)
            $filterSelect.find('option:not(:first)').remove();
            $menuSelect.find('option:not(:first)').remove();
            
            categories.forEach(function(cat) {
                const name = cat.nameCate || cat.name || 'N/A';
                const id = cat.id;
                $filterSelect.append(`<option value="${id}">${escapeHtml(name)}</option>`);
                $menuSelect.append(`<option value="${id}">${escapeHtml(name)}</option>`);
            });
        }

        function loadMenu(restaurantId) {
            if (!restaurantId) {
                restaurantId = $('#restaurant-select').val();
            }
            
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng!');
                return;
            }
            
            console.log("=== loadMenu() called ===");
            console.log("Restaurant ID:", restaurantId);
            
            // Show loading state
            $('#menu-grid').html('<div class="col-12 text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i><p class="mt-3 text-muted">ƒêang t·∫£i menu...</p></div>');
            $('#hidden-menu-grid').html('<div class="col-12 text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i><p class="mt-3 text-muted">ƒêang t·∫£i menu...</p></div>');
            
            OwnerApiService.getRestaurantMenu(restaurantId)
                .done(function(response) {
                    console.log("=== Menu API Response ===");
                    console.log("Full response:", response);
                    console.log("Response success:", response?.success);
                    console.log("Response isSuccess:", response?.isSuccess);
                    console.log("Response data:", response?.data);
                    console.log("Response data type:", typeof response?.data);
                    console.log("Is array:", Array.isArray(response?.data));
                    
                    if (response && (response.success === true || response.isSuccess === true) && response.data) {
                        allMenus = Array.isArray(response.data) ? response.data : [];
                        console.log("‚úÖ Loaded menus:", allMenus.length);
                        
                        if (allMenus.length > 0) {
                            console.log("First menu sample:", allMenus[0]);
                        }
                        
                        renderMenuByStatus();
                    } else {
                        console.warn("‚ö†Ô∏è Invalid response format or no data");
                        console.warn("Response:", response);
                        $('#menu-grid').html('<div class="col-12 alert alert-warning">Kh√¥ng c√≥ menu n√†o</div>');
                        $('#hidden-menu-grid').html('<div class="col-12 alert alert-warning">Kh√¥ng c√≥ menu n√†o</div>');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('=== Error loading menu ===');
                    console.error('XHR:', xhr);
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('Status Code:', xhr.status);
                    console.error('Response Text:', xhr.responseText);
                    console.error('Response JSON:', xhr.responseJSON);
                    
                    let errorMsg = 'L·ªói khi t·∫£i menu';
                    if (xhr.status === 401) {
                        errorMsg = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!';
                    } else if (xhr.status === 403) {
                        errorMsg = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p menu n√†y!';
                    } else if (xhr.responseJSON && xhr.responseJSON.desc) {
                        errorMsg = xhr.responseJSON.desc;
                    }
                    
                    $('#menu-grid').html(`<div class="col-12 alert alert-danger">${errorMsg}</div>`);
                    $('#hidden-menu-grid').html(`<div class="col-12 alert alert-danger">${errorMsg}</div>`);
                });
        }
        
        // Render menu by status (active/hidden)
        function renderMenuByStatus() {
            console.log('=== renderMenuByStatus() called ===');
            console.log('Total menus:', allMenus.length);
            
            // Log first menu to check available field
            if (allMenus.length > 0) {
                console.log('Sample menu fields:', Object.keys(allMenus[0]));
                console.log('Sample menu isAvailable:', allMenus[0].isAvailable);
                console.log('Sample menu available:', allMenus[0].available);
            }
            
            // Filter menus with valid images first
            const menusWithImages = allMenus.filter(m => {
                const imagePath = m.image;
                // Only include menus that have a non-empty image path
                return imagePath && imagePath.trim() !== '';
            });
            
            console.log('Menus with images:', menusWithImages.length, 'out of', allMenus.length);
            
            const activeMenus = menusWithImages.filter(m => {
                // Check multiple possible field names for availability
                // If field doesn't exist, default to true (available)
                if (m.available !== undefined) {
                    return m.available !== false;
                }
                if (m.isAvailable !== undefined) {
                    return m.isAvailable !== false && m.isAvailable !== null;
                }
                // Default: if field doesn't exist, consider it available
                return true;
            });
            
            const hiddenMenus = menusWithImages.filter(m => {
                // Check multiple possible field names for availability
                if (m.available !== undefined) {
                    return m.available === false;
                }
                if (m.isAvailable !== undefined) {
                    return m.isAvailable === false || m.isAvailable === null;
                }
                // Default: if field doesn't exist, consider it available (not hidden)
                return false;
            });
            
            console.log('Active menus (with images):', activeMenus.length);
            console.log('Hidden menus (with images):', hiddenMenus.length);
            
            renderMenu(activeMenus, 'menu-grid');
            renderMenu(hiddenMenus, 'hidden-menu-grid');
        }

        function renderMenu(menus, gridId = 'menu-grid') {
            const $grid = $('#' + gridId);
            
            if (menus.length === 0) {
                const emptyMessage = gridId === 'hidden-menu-grid' 
                    ? '<i class="fas fa-eye-slash fa-3x text-muted mb-3"></i><p class="text-muted">Ch∆∞a c√≥ m√≥n n√†o b·ªã ·∫©n</p>'
                    : '<i class="fas fa-utensils fa-3x text-muted mb-3"></i><p class="text-muted">Ch∆∞a c√≥ m√≥n ƒÉn n√†o</p><button class="btn btn-owner btn-owner-primary mt-3" id="add-menu-btn-empty"><i class="fas fa-plus mr-2"></i>Th√™m m√≥n ƒÉn ƒë·∫ßu ti√™n</button>';
                $grid.html(`
                    <div class="col-12 text-center py-5">
                        ${emptyMessage}
                    </div>
                `);
                // Attach click handler for empty state button
                if (gridId === 'menu-grid') {
                    $('#add-menu-btn-empty').on('click', function() {
                        $('#add-menu-btn').click();
                    });
                }
                return;
            }
            
            let html = '';
            const baseUrl = 'http://localhost:82';
            menus.forEach(function(menu) {
                // X·ª≠ l√Ω image URL - Comprehensive logic with multiple fallbacks
                let imageUrl = '';
                const imagePath = menu.image;
                
                console.log('üîç Processing menu ID:', menu.id, 'Title:', menu.title, 'Image path:', imagePath);
                
                if (imagePath && imagePath.trim() !== '') {
                    const trimmedPath = imagePath.trim();
                    
                    // N·∫øu ƒë√£ l√† URL ƒë·∫ßy ƒë·ªß (http/https)
                    if (trimmedPath.startsWith('http://') || trimmedPath.startsWith('https://')) {
                        imageUrl = trimmedPath;
                        console.log('‚úÖ Using full URL:', imageUrl);
                    }
                    // N·∫øu b·∫Øt ƒë·∫ßu v·ªõi "/" (ƒë√£ ƒë∆∞·ª£c format t·ª´ backend)
                    else if (trimmedPath.startsWith('/')) {
                        imageUrl = `${baseUrl}${trimmedPath}`;
                        console.log('‚úÖ Using formatted path:', imageUrl);
                    }
                    // N·∫øu b·∫Øt ƒë·∫ßu v·ªõi "uploads/" ho·∫∑c "images/"
                    else if (trimmedPath.startsWith('uploads/') || trimmedPath.startsWith('images/')) {
                        imageUrl = `${baseUrl}/${trimmedPath}`;
                        console.log('‚úÖ Using uploads/images path:', imageUrl);
                    }
                    // N·∫øu ch·ªâ l√† filename (c√≥ extension nh∆∞ .jpg, .png)
                    else if (trimmedPath.includes('.') && !trimmedPath.includes('/')) {
                        // Try multiple endpoints
                        imageUrl = `${baseUrl}/menu/file/${trimmedPath}`;
                        console.log('‚úÖ Using menu/file endpoint with filename:', imageUrl);
                    }
                    // N·∫øu c√≥ ch·ª©a "menu" ho·∫∑c "file" nh∆∞ng ch∆∞a ƒë√∫ng format
                    else if (trimmedPath.includes('menu') || trimmedPath.includes('file')) {
                        const fileName = trimmedPath.substring(trimmedPath.lastIndexOf('/') + 1);
                        imageUrl = `${baseUrl}/menu/file/${fileName}`;
                        console.log('‚úÖ Extracted filename from path:', imageUrl);
                    }
                    // M·∫∑c ƒë·ªãnh: th·ª≠ menu/file endpoint
                    else {
                        imageUrl = `${baseUrl}/menu/file/${trimmedPath}`;
                        console.log('‚úÖ Using default menu/file endpoint:', imageUrl);
                    }
                } else {
                    // Default image placeholder
                    imageUrl = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2U5ZTllOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+PGZvcmVpZ25PYmplY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsgaGVpZ2h0OjEwMCU7Ij48aSBjbGFzcz0iZmFzIGZhLXV0ZW5zaWxzIiBzdHlsZT0iZm9udC1zaXplOjQ4cHg7IGNvbG9yOiM5OTk7Ij48L2k+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvdGV4dD48L3N2Zz4=';
                    console.log('‚ö†Ô∏è No image path, using placeholder');
                }
                
                html += `
                    <div class="col-md-4 col-sm-6 mb-4 menu-item-card">
                        <div class="card owner-card h-100 shadow-sm">
                            <div class="menu-image-container" style="position: relative; height: 200px; overflow: hidden; background: #f8f9fa;">
                                <img src="${imageUrl}" 
                                     alt="${escapeHtml(menu.title || 'Menu')}" 
                                     class="menu-image" 
                                     style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2U5ZTllOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+PGZvcmVpZ25PYmplY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OmNlbnRlcjsgaGVpZ2h0OjEwMCU7Ij48aSBjbGFzcz0iZmFzIGZhLXV0ZW5zaWxzIiBzdHlsZT0iZm9udC1zaXplOjQ4cHg7IGNvbG9yOiM5OTk7Ij48L2k+PC9kaXY+PC9mb3JlaWduT2JqZWN0PjwvdGV4dD48L3N2Zz4='; console.error('Failed to load image:', '${imageUrl}');">
                                </img>
                                <div class="menu-status-badge" style="position: absolute; top: 10px; right: 10px;">
                                    ${(() => {
                                        // Determine availability status
                                        let isAvailable = true;
                                        if (menu.available !== undefined) {
                                            isAvailable = menu.available !== false;
                                        } else if (menu.isAvailable !== undefined) {
                                            isAvailable = menu.isAvailable !== false && menu.isAvailable !== null;
                                        }
                                        // Default to available if field doesn't exist
                                        
                                        const badgeClass = isAvailable ? 'success' : 'danger';
                                        const iconClass = isAvailable ? 'check-circle' : 'times-circle';
                                        const statusText = isAvailable ? 'C√≥ s·∫µn' : 'H·∫øt m√≥n';
                                        
                                        return `<span class="badge badge-${badgeClass} badge-pill shadow">
                                            <i class="fas fa-${iconClass} mr-1"></i>${statusText}
                                        </span>`;
                                    })()}
                                </div>
                                ${menu.isFreeShip ? '<div class="menu-freeship-badge" style="position: absolute; top: 10px; left: 10px;"><span class="badge badge-info badge-pill shadow"><i class="fas fa-shipping-fast mr-1"></i>Mi·ªÖn ph√≠ ship</span></div>' : ''}
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-2" style="font-weight: 600; color: #333;">
                                    <i class="fas fa-utensils mr-2 text-primary"></i>${escapeHtml(menu.title || 'N/A')}
                                </h6>
                                <p class="text-muted small mb-3" style="min-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    <i class="fas fa-info-circle mr-1 text-info"></i>${escapeHtml(menu.description || 'Ch∆∞a c√≥ m√¥ t·∫£')}
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-primary font-weight-bold" style="font-size: 1.1rem;">
                                        <i class="fas fa-money-bill-wave mr-1"></i>${formatVND(menu.price || 0)}
                                    </span>
                                    <small class="text-muted">
                                        <i class="fas fa-clock mr-1"></i>${menu.timeShip || 'N/A'}
                                    </small>
                                </div>
                                ${menu.categoryName ? `
                                    <div class="mt-2">
                                        <span class="badge badge-secondary">
                                            <i class="fas fa-tag mr-1"></i>${escapeHtml(menu.categoryName)}
                                        </span>
                                    </div>
                                ` : ''}
                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-owner btn-owner-primary flex-fill" onclick="editMenu(${menu.id})">
                                        <i class="fas fa-edit mr-1"></i>S·ª≠a
                                    </button>
                                    ${(() => {
                                        // Determine availability status for toggle button
                                        let isAvailable = true;
                                        if (menu.available !== undefined) {
                                            isAvailable = menu.available !== false;
                                        } else if (menu.isAvailable !== undefined) {
                                            isAvailable = menu.isAvailable !== false && menu.isAvailable !== null;
                                        }
                                        // Default to available if field doesn't exist
                                        
                                        const toggleValue = isAvailable ? 'true' : 'false';
                                        const iconClass = isAvailable ? 'eye-slash' : 'eye';
                                        const buttonText = isAvailable ? '·∫®n' : 'Hi·ªán';
                                        
                                        return `<button class="btn btn-sm btn-owner btn-owner-secondary flex-fill" onclick="toggleMenuAvailability(${menu.id}, ${toggleValue})">
                                            <i class="fas fa-${iconClass} mr-1"></i>${buttonText}
                                        </button>`;
                                    })()}
                                    <button class="btn btn-sm btn-owner btn-danger flex-fill" onclick="deleteMenu(${menu.id})" title="X√≥a m√≥n ƒÉn">
                                        <i class="fas fa-trash mr-1"></i>X√≥a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $grid.html(html);
            
            // Add hover effect for images
            $('.menu-image').hover(
                function() { $(this).css('transform', 'scale(1.05)'); },
                function() { $(this).css('transform', 'scale(1)'); }
            );
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        let currentEditMenuId = null;
        let currentRestaurantId = null;

        // Add menu button click
        $('#add-menu-btn').on('click', function() {
            const restaurantId = $('#restaurant-select').val();
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng tr∆∞·ªõc!');
                return;
            }
            currentRestaurantId = restaurantId;
            currentEditMenuId = null;
            resetMenuForm();
            $('#menuModalLabel').text('Th√™m m√≥n ƒÉn m·ªõi');
            $('#image-required').show();
            $('#menuModal').modal('show');
        });

        // Edit menu
        function editMenu(menuId) {
            console.log('=== editMenu() called ===');
            console.log('Menu ID:', menuId);
            
            const restaurantId = $('#restaurant-select').val();
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng!');
                return;
            }
            
            currentRestaurantId = restaurantId;
            currentEditMenuId = menuId;
            
            // Find menu in allMenus
            const menu = allMenus.find(m => m.id === menuId);
            if (!menu) {
                alert('Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn!');
                return;
            }
            
            console.log('Menu found:', menu);
            
            // Fill form with menu data
            $('#menu-id').val(menu.id);
            $('#menu-title').val(menu.title || '');
            $('#menu-description').val(menu.description || menu.desc || '');
            $('#menu-price').val(menu.price || 0);
            $('#menu-shipping-fee').val(menu.shippingFee || 15000);
            $('#menu-time-ship').val(menu.timeShip || menu.time_ship || '');
            $('#menu-is-freeship').prop('checked', menu.isFreeShip || menu.is_freeship || false);
            
            // Set category
            const categoryId = menu.cateId || menu.categoryId || '';
            $('#menu-category').val(categoryId);
            
            // Show current image
            const imagePath = menu.image || '';
            if (imagePath) {
                let imageUrl = '';
                const baseUrl = 'http://localhost:82';
                
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    imageUrl = imagePath;
                } else if (imagePath.startsWith('/')) {
                    imageUrl = `${baseUrl}${imagePath}`;
                } else if (imagePath.startsWith('images/')) {
                    imageUrl = `${baseUrl}/${imagePath}`;
                } else {
                    imageUrl = `${baseUrl}/menu/file/${imagePath}`;
                }
                
                $('#menu-current-image').attr('src', imageUrl).on('error', function() {
                    $(this).attr('src', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2U5ZTllOSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+');
                });
                $('#menu-image-preview').show();
            } else {
                $('#menu-image-preview').hide();
            }
            
            $('#menu-new-image-preview').hide();
            $('#menuModalLabel').text('Ch·ªânh s·ª≠a m√≥n ƒÉn');
            $('#image-required').hide();
            $('#menuModal').modal('show');
        }
        
        // Reset menu form
        function resetMenuForm() {
            $('#menu-form')[0].reset();
            $('#menu-id').val('');
            $('#menu-image-preview').hide();
            $('#menu-new-image-preview').hide();
            $('#menu-current-image').attr('src', '');
        }
        
        // Preview new image
        $('#menu-image').on('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#menu-preview-img').attr('src', e.target.result);
                    $('#menu-new-image-preview').show();
                };
                reader.readAsDataURL(file);
            } else {
                $('#menu-new-image-preview').hide();
            }
        });
        
        // Save menu (add or update)
        $('#save-menu-btn').on('click', function() {
            const restaurantId = $('#restaurant-select').val();
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng!');
                return;
            }
            
            const title = $('#menu-title').val().trim();
            const description = $('#menu-description').val().trim();
            const categoryId = $('#menu-category').val();
            const price = parseFloat($('#menu-price').val());
            const shippingFee = parseFloat($('#menu-shipping-fee').val()) || 15000;
            const timeShip = $('#menu-time-ship').val().trim();
            const isFreeShip = $('#menu-is-freeship').is(':checked');
            const imageFile = $('#menu-image')[0].files[0];
            
            // Validation
            if (!title) {
                alert('Vui l√≤ng nh·∫≠p t√™n m√≥n ƒÉn!');
                return;
            }
            
            if (!categoryId) {
                alert('Vui l√≤ng ch·ªçn danh m·ª•c!');
                return;
            }
            
            if (!price || price <= 0) {
                alert('Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá (l·ªõn h∆°n 0)!');
                return;
            }
            
            // For new menu, image is required
            if (!currentEditMenuId && !imageFile) {
                alert('Vui l√≤ng ch·ªçn ·∫£nh m√≥n ƒÉn!');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            if (imageFile) {
                formData.append('file', imageFile);
            }
            formData.append('title', title);
            if (description) {
                formData.append('description', description);
            }
            if (timeShip) {
                formData.append('time_ship', timeShip);
            }
            formData.append('price', price);
            formData.append('cate_id', categoryId);
            formData.append('is_freeship', isFreeShip ? 'true' : 'false');
            formData.append('shippingFee', shippingFee);
            
            // Disable button
            const submitBtn = $('#save-menu-btn');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang l∆∞u...');
            
            if (currentEditMenuId) {
                // Update existing menu
                OwnerApiService.updateMenu(restaurantId, currentEditMenuId, formData)
                    .done(function(response) {
                        console.log('Update menu response:', response);
                        if (response && (response.success || response.isSuccess)) {
                            alert('C·∫≠p nh·∫≠t m√≥n ƒÉn th√†nh c√¥ng!');
                            $('#menuModal').modal('hide');
                            loadMenu(restaurantId);
                        } else {
                            alert(response?.desc || 'C·∫≠p nh·∫≠t m√≥n ƒÉn th·∫•t b·∫°i!');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Error updating menu:', error);
                        console.error('Response:', xhr.responseText);
                        const errorMsg = xhr.responseJSON?.desc || 'C·∫≠p nh·∫≠t m√≥n ƒÉn th·∫•t b·∫°i!';
                        alert(errorMsg);
                    })
                    .always(function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    });
            } else {
                // Create new menu
                OwnerApiService.createMenu(restaurantId, formData)
                    .done(function(response) {
                        console.log('Create menu response:', response);
                        if (response && (response.success || response.isSuccess)) {
                            alert('T·∫°o m√≥n ƒÉn th√†nh c√¥ng!');
                            $('#menuModal').modal('hide');
                            loadMenu(restaurantId);
                        } else {
                            alert(response?.desc || 'T·∫°o m√≥n ƒÉn th·∫•t b·∫°i!');
                        }
                    })
                    .fail(function(xhr, status, error) {
                        console.error('Error creating menu:', error);
                        console.error('Response:', xhr.responseText);
                        const errorMsg = xhr.responseJSON?.desc || 'T·∫°o m√≥n ƒÉn th·∫•t b·∫°i!';
                        alert(errorMsg);
                    })
                    .always(function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    });
            }
        });
        
        // Toggle menu availability
        function toggleMenuAvailability(menuId, currentStatus) {
            const restaurantId = $('#restaurant-select').val();
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng!');
                return;
            }
            
            const newStatus = !currentStatus;
            const action = newStatus ? 'hi·ªÉn th·ªã' : '·∫©n';
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} m√≥n ƒÉn n√†y?`)) {
                return;
            }
            
            OwnerApiService.toggleMenu(restaurantId, menuId, newStatus)
                .done(function(response) {
                    console.log('=== Toggle menu response ===');
                    console.log('Full response:', response);
                    console.log('Response data:', response?.data);
                    
                    if (response && (response.success || response.isSuccess)) {
                        alert(`${action.charAt(0).toUpperCase() + action.slice(1)} m√≥n ƒÉn th√†nh c√¥ng!`);
                        
                        // Reload menu to reflect changes
                        loadMenu(restaurantId);
                        
                        // If hiding, switch to hidden tab; if showing, switch to active tab
                        setTimeout(function() {
                            if (!newStatus) {
                                // Just hidden - switch to hidden tab
                                $('#hidden-menu-tab').tab('show');
                                console.log('‚úÖ Switched to hidden menu tab');
                            } else {
                                // Just shown - switch to active tab
                                $('#active-menu-tab').tab('show');
                                console.log('‚úÖ Switched to active menu tab');
                            }
                        }, 500);
                    } else {
                        alert(response?.desc || `${action.charAt(0).toUpperCase() + action.slice(1)} m√≥n ƒÉn th·∫•t b·∫°i!`);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('=== Error toggling menu ===');
                    console.error('XHR:', xhr);
                    console.error('Status:', status);
                    console.error('Error:', error);
                    console.error('Response text:', xhr.responseText);
                    
                    let errorMsg = `${action.charAt(0).toUpperCase() + action.slice(1)} m√≥n ƒÉn th·∫•t b·∫°i!`;
                    if (xhr.responseJSON && xhr.responseJSON.desc) {
                        errorMsg = xhr.responseJSON.desc;
                    } else if (xhr.status === 401) {
                        errorMsg = 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!';
                    } else if (xhr.status === 403) {
                        errorMsg = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y!';
                    } else if (xhr.status === 404) {
                        errorMsg = 'Kh√¥ng t√¨m th·∫•y m√≥n ƒÉn!';
                    }
                    alert(errorMsg);
                });
        }
        
        // Delete menu
        function deleteMenu(menuId) {
            const restaurantId = $('#restaurant-select').val();
            if (!restaurantId) {
                alert('Vui l√≤ng ch·ªçn c·ª≠a h√†ng!');
                return;
            }
            
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA m√≥n ƒÉn n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                return;
            }
            
            // Call delete API
            OwnerApiService.deleteMenu(restaurantId, menuId)
                .done(function(response) {
                    console.log('Delete menu response:', response);
                    if (response && (response.success || response.isSuccess)) {
                        alert('X√≥a m√≥n ƒÉn th√†nh c√¥ng!');
                        loadMenu(restaurantId);
                    } else {
                        alert(response?.desc || 'X√≥a m√≥n ƒÉn th·∫•t b·∫°i!');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Error deleting menu:', error);
                    const errorMsg = xhr.responseJSON?.desc || 'X√≥a m√≥n ƒÉn th·∫•t b·∫°i!';
                    alert(errorMsg);
                });
        }

        function filterMenu() {
            const searchTerm = $('#search-menu').val().toLowerCase();
            const categoryFilter = $('#filter-category').val();
            
            let filtered = allMenus.filter(function(menu) {
                // Only show active menus in active tab
                // If isAvailable is undefined/null, consider it as available (true)
                if (menu.isAvailable === false) {
                    return false;
                }
                // If isAvailable is undefined/null, show it (default to available)
                if (searchTerm && !menu.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                if (categoryFilter && menu.cateId && menu.cateId.toString() !== categoryFilter) {
                    return false;
                }
                return true;
            });
            
            renderMenu(filtered, 'menu-grid');
        }
        
        // Filter hidden menu
        function filterHiddenMenu() {
            const searchTerm = $('#search-hidden-menu').val().toLowerCase();
            const categoryFilter = $('#filter-hidden-category').val();
            
            let filtered = allMenus.filter(function(menu) {
                // Only show menus with images
                const imagePath = menu.image;
                if (!imagePath || imagePath.trim() === '') {
                    return false;
                }
                
                // Only show hidden menus
                // Check availability status
                let isAvailable = true;
                if (menu.available !== undefined) {
                    isAvailable = menu.available !== false;
                } else if (menu.isAvailable !== undefined) {
                    isAvailable = menu.isAvailable !== false && menu.isAvailable !== null;
                }
                // Default to available if field doesn't exist
                
                // Only show if explicitly set to false (hidden)
                if (isAvailable) {
                    return false; // Don't show active menus in hidden tab
                }
                
                // Apply search filter
                if (searchTerm && !menu.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Apply category filter
                if (categoryFilter && menu.cateId && menu.cateId.toString() !== categoryFilter) {
                    return false;
                }
                
                return true;
            });
            
            renderMenu(filtered, 'hidden-menu-grid');
        }

        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
    </script>
</body>
</html>

