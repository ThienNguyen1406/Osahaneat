<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="OSAHANEAT - Lịch sử giao hàng" />
    <meta name="author" content="OSAHANEAT" />
    <title>OSAHANEAT - Lịch sử giao hàng</title>
    <link rel="icon" type="image/png" href="../admin/img/favicon.png">
    <link href="../admin/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fontawesome Icon - CDN for better compatibility -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Fallback to local -->
    <link href="../admin/vendor/fontawesome/css/fontawesome.min.css" rel="stylesheet" type="text/css">
    <link href="css/shipper.css" rel="stylesheet" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark shipper-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-motorcycle mr-2"></i>
                <strong>OSAHANEAT</strong> <span class="badge badge-warning ml-2">SHIPPER</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">
                            <i class="fas fa-shopping-bag"></i> Đơn hàng
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="history.html">
                            <i class="fas fa-history"></i> Lịch sử
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">
                            <i class="fas fa-user"></i> Hồ sơ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html" onclick="shipperLogout(); return false;">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="shipper-page-title">
                    <i class="fas fa-history mr-2"></i>Lịch sử giao hàng
                </h2>
                <p class="text-muted">
                    <i class="fas fa-clock mr-1"></i>Xem tất cả đơn hàng đã giao
                </p>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    </div>
                    <input type="date" class="form-control" id="filter-date" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fas fa-filter"></i></span>
                    </div>
                    <select class="form-control" id="filter-status">
                        <option value="">Tất cả trạng thái</option>
                        <option value="delivered">Đã giao</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary btn-block" onclick="loadHistory()">
                    <i class="fas fa-search mr-2"></i>Tìm kiếm
                </button>
            </div>
        </div>

        <!-- History Table -->
        <div class="card">
            <div class="card-header shipper-card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list mr-2"></i>
                    Danh sách đơn hàng
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="history-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag mr-1"></i>Mã đơn</th>
                                <th><i class="fas fa-store mr-1"></i>Nhà hàng</th>
                                <th><i class="fas fa-map-marker-alt mr-1"></i>Địa chỉ giao</th>
                                <th><i class="fas fa-money-bill-wave mr-1"></i>Tổng tiền</th>
                                <th><i class="fas fa-truck mr-1"></i>Phí giao hàng</th>
                                <th><i class="fas fa-calendar mr-1"></i>Ngày tạo</th>
                                <th><i class="fas fa-check-circle mr-1"></i>Ngày giao</th>
                                <th><i class="fas fa-info-circle mr-1"></i>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="history-pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../admin/vendor/jquery/jquery.min.js"></script>
    <script src="../admin/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../admin/js/api.js"></script>
    <script src="js/shipper.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 20;

        $(document).ready(function() {
            if (!isAuthenticated()) {
                alert('Vui lòng đăng nhập!');
                window.location.href = 'login.html';
                return;
            }
            
            // Set today as default date
            const today = new Date().toISOString().split('T')[0];
            $('#filter-date').val(today);
            
            loadHistory();
        });

        function loadHistory(page = 0) {
            currentPage = page;
            
            ShipperApiService.getDeliveryHistory()
                .done(function(response) {
                    let orders = [];
                    let totalElements = 0;
                    let totalPages = 0;
                    
                    if (response && (response.success || response.isSuccess) && response.data) {
                        if (response.data.orders) {
                            orders = Array.isArray(response.data.orders) ? response.data.orders : [];
                            totalElements = response.data.totalElements || 0;
                            totalPages = response.data.totalPages || 0;
                        } else if (Array.isArray(response.data)) {
                            orders = response.data;
                        }
                    }
                    
                    renderHistoryTable(orders);
                    renderPagination(totalPages, currentPage);
                })
                .fail(function(xhr) {
                    console.error('Error loading history:', xhr);
                    $('#history-tbody').html('<tr><td colspan="8" class="text-center text-danger">Lỗi khi tải lịch sử</td></tr>');
                });
        }

        function renderHistoryTable(orders) {
            const $tbody = $('#history-tbody');
            
            if (orders.length === 0) {
                $tbody.html('<tr><td colspan="8" class="text-center"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><p class="text-muted">Chưa có đơn hàng nào</p></td></tr>');
                return;
            }
            
            let html = '';
            orders.forEach(function(order) {
                html += `
                    <tr>
                        <td><strong>#${order.id}</strong></td>
                        <td>${order.restaurantTitle || 'N/A'}</td>
                        <td>${order.deliveryAddress || 'Chưa cập nhật'}</td>
                        <td><strong>${formatVND(order.totalPrice || 0)}</strong></td>
                        <td>${formatVND(order.deliveryFee || 0)}</td>
                        <td>${formatDate(order.createDate)}</td>
                        <td>${order.deliveredAt ? formatDate(order.deliveredAt) : '-'}</td>
                        <td>
                            <span class="badge badge-${getStatusBadgeColor(order.status)}">
                                <i class="fas fa-${getStatusIcon(order.status)} mr-1"></i>${getStatusText(order.status)}
                            </span>
                        </td>
                    </tr>
                `;
            });
            $tbody.html(html);
        }

        function renderPagination(totalPages, currentPage) {
            const $pagination = $('#history-pagination');
            
            if (totalPages <= 1) {
                $pagination.html('');
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadHistory(${currentPage - 1}); return false;">Trước</a>
            </li>`;
            
            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadHistory(${i}); return false;">${i + 1}</a>
                    </li>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // Next button
            html += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadHistory(${currentPage + 1}); return false;">Sau</a>
            </li>`;
            
            $pagination.html(html);
        }

        function getStatusBadgeColor(status) {
            const colors = {
                'delivered': 'success',
                'cancelled': 'danger',
                'accepted': 'info',
                'picked_up': 'primary'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'delivered': 'Đã giao',
                'cancelled': 'Đã hủy',
                'accepted': 'Đã nhận',
                'picked_up': 'Đã lấy hàng'
            };
            return texts[status] || status;
        }

        function getStatusIcon(status) {
            const icons = {
                'delivered': 'check-double',
                'cancelled': 'times-circle',
                'accepted': 'hand-paper',
                'picked_up': 'box'
            };
            return icons[status] || 'info-circle';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN');
        }

        function formatVND(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
    </script>
</body>
</html>

