<!DOCTYPE html>
<html lang="vi">
   <head>
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
      <meta name="description" content="OSAHANEAT - Hệ thống quản lý đặt món ăn" />
      <meta name="author" content="OSAHANEAT" />
      <title>OSAHANEAT - Quản lý phân quyền</title>
      <!-- Favicon Icon -->
      <link rel="icon" type="image/png" href="img/favicon.png?v=2.0">
      <!-- Feather Icon-->
      <link href="vendor/icons/feather.css?v=2.0" rel="stylesheet" type="text/css">
      <!-- Fontawesome Icon-->
      <link href="vendor/fontawesome/css/fontawesome.min.css?v=2.0" rel="stylesheet" type="text/css">
      <!-- Bootstrap Css -->
      <link href="vendor/bootstrap/css/bootstrap.min.css?v=2.0" rel="stylesheet">
      <!-- Custom Css -->
      <link href="css/styles.css?v=2.0" rel="stylesheet" />
      <!-- Datatables css -->
      <link href="vendor/dataTables/dataTables/css/dataTables.bootstrap4.min.css?v=2.0" rel="stylesheet">
   </head>
   <body class="sb-nav-fixed">
      <nav class="sb-topnav navbar navbar-expand navbar-light bg-white shadow-sm">
         <a class="navbar-brand" href="index.html"><img alt="logo" src="img/logo.png"></a>
         <button class="btn btn-link btn-sm order-1 order-lg-0" id="sidebarToggle" href="#"><i class="fas fa-bars"></i></button>
         <!-- Navbar-->
         <ul class="navbar-nav ml-auto ml-md-0">
            <!-- Nav Item - User Information -->
            <li class="nav-item dropdown no-arrow ml-1 osahan-profile-dropdown">
               <a class="nav-link dropdown-toggle pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
               <img class="img-profile rounded-circle" src="img/user/1.png">
               </a>
               <!-- Dropdown - User Information -->
               <div class="dropdown-menu dropdown-menu-right shadow-sm">
                  <div class="p-3 d-flex align-items-center">
                     <div class="dropdown-list-image mr-3">
                        <img class="rounded-circle" src="img/user/1.png" alt="">
                        <div class="status-indicator bg-success"></div>
                     </div>
                     <div class="font-weight-bold">
                        <div class="text-truncate">Quản trị viên</div>
                        <div class="small text-gray-500">Quản lý hệ thống</div>
                     </div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="my-profile.html"><i class="feather-edit"></i> Tài khoản của tôi</a>
                  <a class="dropdown-item" href="my-profile.html"><i class="feather-settings"></i> Cài đặt tài khoản</a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="login.html" onclick="adminLogout(); return false;"><i class="feather-log-out"></i> Đăng xuất</a>
               </div>
            </li>
         </ul>
      </nav>
      <div id="layoutSidenav">
         <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
               <div class="sb-sidenav-menu">
                  <div class="nav">
                     <div class="sb-sidenav-menu-heading">Chức năng</div>
                     <a class="nav-link" href="index.html">
                        <div class="sb-nav-link-icon"><i class="feather-home"></i></div>
                        Bảng điều khiển
                     </a>
                     <a class="nav-link" href="listings.html">
                        <div class="sb-nav-link-icon"><i class="feather-list"></i></div>
                        Quản lý nhà hàng
                     </a>
                     <a class="nav-link" href="users.html">
                        <div class="sb-nav-link-icon"><i class="feather-users"></i></div>
                        Quản lý người dùng
                     </a>
                     <a class="nav-link" href="shippers.html">
                        <div class="sb-nav-link-icon"><i class="feather-truck"></i></div>
                        Quản lý shipper
                     </a>
                     <a class="nav-link active" href="permissions.html">
                        <div class="sb-nav-link-icon"><i class="feather-shield"></i></div>
                        Quản lý phân quyền
                     </a>
                     <a class="nav-link" href="categories.html">
                        <div class="sb-nav-link-icon"><i class="feather-tag"></i></div>
                        Quản lý danh mục
                     </a>
                     <a class="nav-link" href="menus.html">
                        <div class="sb-nav-link-icon"><i class="feather-coffee"></i></div>
                        Quản lý món ăn
                     </a>
                     <a class="nav-link" href="messages.html">
                        <div class="sb-nav-link-icon"><i class="feather-message-square"></i></div>
                        Quản lý tin nhắn
                        <span class="badge badge-pill ml-2 badge-danger" id="sidebar-message-badge" style="display: none;">0</span>
                     </a>
                  </div>
               </div>
               <div class="sb-sidenav-footer">
                  <div class="small">Đăng nhập với:</div>
                  Quản trị viên
               </div>
            </nav>
         </div>
         <div id="layoutSidenav_content">
            <main>
               <div class="container-fluid">
                  <h1 class="mt-4"><i class="feather-shield mr-2"></i>Quản lý phân quyền</h1>
                  <ol class="breadcrumb mb-4">
                     <li class="breadcrumb-item"><a href="index.html">Bảng điều khiển</a></li>
                     <li class="breadcrumb-item active">Quản lý phân quyền</li>
                  </ol>
                  
                  <!-- Roles Overview -->
                  <div class="row mb-4">
                     <div class="col-md-3">
                        <div class="card bg-primary text-white mb-4">
                           <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center">
                                 <div>
                                    <div class="stat-value" style="font-size: 2rem; font-weight: bold;" id="admin-count">0</div>
                                    <div class="stat-label"><i class="feather-shield mr-1"></i>Admin</div>
                                 </div>
                                 <div class="stat-icon" style="font-size: 3rem; opacity: 0.3;">
                                    <i class="feather-shield"></i>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div class="card bg-success text-white mb-4">
                           <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center">
                                 <div>
                                    <div class="stat-value" style="font-size: 2rem; font-weight: bold;" id="user-count">0</div>
                                    <div class="stat-label"><i class="feather-users mr-1"></i>User</div>
                                 </div>
                                 <div class="stat-icon" style="font-size: 3rem; opacity: 0.3;">
                                    <i class="feather-users"></i>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div class="card bg-warning text-white mb-4">
                           <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center">
                                 <div>
                                    <div class="stat-value" style="font-size: 2rem; font-weight: bold;" id="staff-count">0</div>
                                    <div class="stat-label"><i class="feather-utensils mr-1"></i>Staff</div>
                                 </div>
                                 <div class="stat-icon" style="font-size: 3rem; opacity: 0.3;">
                                    <i class="feather-utensils"></i>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="col-md-3">
                        <div class="card bg-info text-white mb-4">
                           <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center">
                                 <div>
                                    <div class="stat-value" style="font-size: 2rem; font-weight: bold;" id="driver-count">0</div>
                                    <div class="stat-label"><i class="feather-truck mr-1"></i>Driver</div>
                                 </div>
                                 <div class="stat-icon" style="font-size: 3rem; opacity: 0.3;">
                                    <i class="feather-truck"></i>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
                  
                  <!-- Roles Table -->
                  <div class="row">
                     <div class="col-xl-12">
                        <div class="card mb-4">
                           <div class="card-header d-flex justify-content-between align-items-center">
                              <div>
                                 <i class="fas fa-table mr-1"></i>
                                 Danh sách vai trò
                              </div>
                              <button class="btn btn-primary btn-sm" onclick="showAddRoleModal()">
                                 <i class="feather-plus mr-1"></i>Thêm vai trò
                              </button>
                           </div>
                           <div class="card-body">
                              <div class="table-responsive">
                                 <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                    <thead>
                                       <tr>
                                          <th><i class="feather-hash mr-1"></i>ID</th>
                                          <th><i class="feather-shield mr-1"></i>Tên vai trò</th>
                                          <th><i class="feather-users mr-1"></i>Số người dùng</th>
                                          <th><i class="feather-info mr-1"></i>Mô tả</th>
                                          <th><i class="feather-settings mr-1"></i>Thao tác</th>
                                       </tr>
                                    </thead>
                                    <tbody>
                                       <tr>
                                          <td colspan="5" class="text-center py-4">
                                             <i class="feather-loader"></i> Đang tải...
                                          </td>
                                       </tr>
                                    </tbody>
                                 </table>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </main>
            <footer class="py-4 bg-light mt-auto">
               <div class="container-fluid">
                  <div class="d-flex align-items-center justify-content-between small">
                     <div class="text-muted">Copyright &copy; OSAHANEAT 2024</div>
                  </div>
               </div>
            </footer>
         </div>
      </div>
      <!-- Add/Edit Role Modal -->
      <div class="modal fade" id="role-modal" tabindex="-1" role="dialog" aria-labelledby="roleModalLabel" aria-hidden="true">
         <div class="modal-dialog" role="document">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title" id="roleModalLabel">Thêm vai trò mới</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                  </button>
               </div>
               <div class="modal-body">
                  <form id="role-form">
                     <input type="hidden" id="role-id">
                     <div class="form-group">
                        <label for="role-name">Tên vai trò <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="role-name" placeholder="VD: ADMIN, USER, DRIVER" required>
                        <small class="form-text text-muted">Tên vai trò phải viết hoa, không có khoảng trắng</small>
                     </div>
                     <div class="form-group">
                        <label for="role-description">Mô tả</label>
                        <textarea class="form-control" id="role-description" rows="3" placeholder="Mô tả vai trò này..."></textarea>
                     </div>
                  </form>
               </div>
               <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                  <button type="button" class="btn btn-primary" id="save-role-btn" onclick="saveRole()">Lưu</button>
               </div>
            </div>
         </div>
      </div>

      <!-- Scripts -->
      <script src="vendor/jquery/jquery.min.js"></script>
      <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
      <script src="js/api.js"></script>
      <script src="js/admin.js"></script>
      <script>
         $(document).ready(function() {
             console.log("=== permissions.html loaded ===");
             
             if (typeof isAuthenticated === 'function' && !isAuthenticated()) {
                 alert('Vui lòng đăng nhập để truy cập trang này!');
                 window.location.href = 'login.html';
                 return;
             }
             
             loadRoles();
         });
         
         function loadRoles() {
             const tbody = $('#dataTable tbody');
             tbody.html('<tr><td colspan="5" class="text-center py-4"><i class="feather-loader"></i> Đang tải...</td></tr>');
             
             // Load roles from API
             AdminApiService.getRoles()
                 .done(function(response) {
                     console.log("Roles response:", response);
                     
                     if (response && (response.isSuccess || response.success) && response.data) {
                         const roles = Array.isArray(response.data) ? response.data : [];
                         renderRoles(roles);
                         updateRoleCounts(roles);
                     } else {
                         tbody.html('<tr><td colspan="5" class="text-center py-4 text-muted">Không có dữ liệu</td></tr>');
                     }
                 })
                 .fail(function(xhr) {
                     console.error("Error loading roles:", xhr);
                     tbody.html('<tr><td colspan="5" class="text-center py-4 text-danger">Lỗi khi tải dữ liệu</td></tr>');
                 });
         }
         
         function renderRoles(roles) {
             const tbody = $('#dataTable tbody');
             
             if (roles.length === 0) {
                 tbody.html('<tr><td colspan="5" class="text-center py-4 text-muted"><i class="feather-shield mr-2"></i>Chưa có vai trò nào</td></tr>');
                 return;
             }
             
             let html = '';
             roles.forEach(function(role) {
                 const roleName = role.roleName || role.name || 'N/A';
                 const userCount = role.userCount || 0;
                 
                 html += `
                     <tr>
                         <td>${role.id || 'N/A'}</td>
                         <td><strong>${roleName}</strong></td>
                         <td>
                             <a href="users.html?role=${roleName}" class="badge badge-info" style="cursor: pointer;">
                                 ${userCount} người dùng
                             </a>
                         </td>
                         <td>${role.description || 'Chưa có mô tả'}</td>
                         <td>
                             <button class="btn btn-sm btn-primary mr-1" onclick="editRole(${role.id})" title="Sửa">
                                 <i class="feather-edit"></i>
                             </button>
                             <button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})" title="Xóa">
                                 <i class="feather-trash-2"></i>
                             </button>
                         </td>
                     </tr>
                 `;
             });
             
             tbody.html(html);
         }
         
         function updateRoleCounts(roles) {
             let adminCount = 0, userCount = 0, staffCount = 0, driverCount = 0;
             
             roles.forEach(function(role) {
                 const roleName = (role.roleName || role.name || '').toUpperCase();
                 const count = role.userCount || 0;
                 
                 if (roleName.includes('ADMIN')) adminCount += count;
                 else if (roleName.includes('USER')) userCount += count;
                 else if (roleName.includes('STAFF')) staffCount += count;
                 else if (roleName.includes('DRIVER')) driverCount += count;
             });
             
             $('#admin-count').text(adminCount);
             $('#user-count').text(userCount);
             $('#staff-count').text(staffCount);
             $('#driver-count').text(driverCount);
         }
         
         function showAddRoleModal() {
             $('#role-modal .modal-title').text('Thêm vai trò mới');
             $('#role-form')[0].reset();
             $('#role-id').val('');
             $('#role-modal').modal('show');
         }
         
         function editRole(id) {
             // Load role details
             AdminApiService.getRoles()
                 .done(function(response) {
                     if (response && (response.isSuccess || response.success) && response.data) {
                         const roles = Array.isArray(response.data) ? response.data : [];
                         const role = roles.find(r => r.id === id);
                         
                         if (role) {
                             $('#role-modal .modal-title').text('Chỉnh sửa vai trò');
                             $('#role-id').val(role.id);
                             $('#role-name').val(role.roleName || '');
                             $('#role-description').val(role.description || '');
                             $('#role-modal').modal('show');
                         } else {
                             alert('Không tìm thấy vai trò!');
                         }
                     }
                 })
                 .fail(function(xhr) {
                     console.error("Error loading role:", xhr);
                     alert('Không thể tải thông tin vai trò!');
                 });
         }
         
         function saveRole() {
             const roleId = $('#role-id').val();
             const roleName = $('#role-name').val().trim().toUpperCase();
             const description = $('#role-description').val().trim();
             
             // Validation
             if (!roleName) {
                 alert('Vui lòng nhập tên vai trò!');
                 return;
             }
             
             // Validate role name format (no spaces, uppercase)
             if (roleName.includes(' ') || roleName !== roleName.toUpperCase()) {
                 alert('Tên vai trò phải viết hoa và không có khoảng trắng!');
                 return;
             }
             
             const saveBtn = $('#save-role-btn');
             const originalText = saveBtn.html();
             saveBtn.prop('disabled', true).html('<i class="feather-loader spinner-border spinner-border-sm"></i> Đang lưu...');
             
             let apiCall;
             if (roleId) {
                 // Update existing role
                 apiCall = AdminApiService.updateRole(roleId, roleName, description);
             } else {
                 // Create new role
                 apiCall = AdminApiService.createRole(roleName, description);
             }
             
             apiCall
                 .done(function(response) {
                     console.log("Save role response:", response);
                     if (response && (response.isSuccess || response.success || response.status === 200)) {
                         alert(roleId ? 'Cập nhật vai trò thành công!' : 'Tạo vai trò thành công!');
                         $('#role-modal').modal('hide');
                         $('#role-form')[0].reset();
                         loadRoles();
                     } else {
                         alert(response?.desc || 'Lưu vai trò thất bại!');
                     }
                 })
                 .fail(function(xhr) {
                     console.error("Error saving role:", xhr);
                     const errorMsg = xhr.responseJSON?.desc || 'Lưu vai trò thất bại!';
                     alert(errorMsg);
                 })
                 .always(function() {
                     saveBtn.prop('disabled', false).html(originalText);
                 });
         }
         
         function deleteRole(id) {
             // Load role details to show name
             AdminApiService.getRoles()
                 .done(function(response) {
                     if (response && (response.isSuccess || response.success) && response.data) {
                         const roles = Array.isArray(response.data) ? response.data : [];
                         const role = roles.find(r => r.id === id);
                         const roleName = role ? (role.roleName || 'vai trò này') : 'vai trò này';
                         
                         if (confirm(`Bạn có chắc chắn muốn xóa vai trò "${roleName}"?\n\nLưu ý: Không thể xóa vai trò nếu vẫn còn người dùng đang sử dụng.`)) {
                             const deleteBtn = event.target;
                             const originalText = deleteBtn.innerHTML;
                             deleteBtn.disabled = true;
                             deleteBtn.innerHTML = '<i class="feather-loader spinner-border spinner-border-sm"></i>';
                             
                             AdminApiService.deleteRole(id)
                                 .done(function(response) {
                                     console.log("Delete role response:", response);
                                     if (response && (response.isSuccess || response.success || response.status === 200)) {
                                         alert('Xóa vai trò thành công!');
                                         loadRoles();
                                     } else {
                                         alert(response?.desc || 'Xóa vai trò thất bại!');
                                         deleteBtn.disabled = false;
                                         deleteBtn.innerHTML = originalText;
                                     }
                                 })
                                 .fail(function(xhr) {
                                     console.error("Error deleting role:", xhr);
                                     const errorMsg = xhr.responseJSON?.desc || 'Xóa vai trò thất bại!';
                                     alert(errorMsg);
                                     deleteBtn.disabled = false;
                                     deleteBtn.innerHTML = originalText;
                                 });
                         }
                     }
                 })
                 .fail(function(xhr) {
                     console.error("Error loading roles:", xhr);
                     alert('Không thể tải thông tin vai trò!');
                 });
         }
         
         // Handle Enter key in role form
         $('#role-form').on('submit', function(e) {
             e.preventDefault();
             saveRole();
         });
      </script>
   </body>
</html>

